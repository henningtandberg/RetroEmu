name: "Create release MacOS"

on:
  # workflow_call is a required field of the "on" property,
  # when intending to use the workflow as a reusable workflow
  workflow_call:
    inputs:
      SOLUTION_PATH:
        required: true
        type: string
      PROJECT_PATH:
        required: true
        type: string
      DOTNET_VERSION:
        required: true
        type: string
      APPLICATION_TARGET_NAME:
        required: true
        type: string
      APPLICATION_VERSION:
        required: true
        type: string

jobs:
  release:
    runs-on: macos-latest
    
    strategy:
      matrix:
        runtime:
          - osx-arm64
          - osx-x64
    
    env:
      APPLICATION_NAME: "${{ inputs.APPLICATION_TARGET_NAME }}-${{ inputs.APPLICATION_VERSION }}-${{ matrix.runtime }}"
      PUBLISH_DIR: publish/${{ matrix.runtime }}
      
    steps:
      - name: "Checkout"
        uses: actions/checkout@v4
        with:
          fetch-depth: '1'

      - name: "Setup .NET"
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ inputs.DOTNET_VERSION }}
          cache: 'true'
          cache-dependency-path: '**/packages.lock.json'

      - name: "Restore"
        run: dotnet restore ${{ inputs.SOLUTION_PATH }}

      - name: "Publish NativeAOT executable"
        run: |
          dotnet publish ${{ inputs.PROJECT_PATH }} \
            -c Release \
            -r ${{ matrix.runtime }} \
            -o $PUBLISH_DIR \
            /p:PublishAot=true \
            /p:SelfContained=true \
            /p:InvariantGlobalization=true \
            /p:PublishTrimmed=true \
            /p:TrimMode=full \
            /p:StripSymbols=true \
            /p:DebugType=none \
            /p:DebugSymbols=false
          
      - name: "macOS: Bundle as .app + DMG + include libs + checksum"
        run: |
          APPLICATION_BUNDLE_DIR=${{ inputs.APPLICATION_TARGET_NAME }}.app

          mkdir -p $PUBLISH_DIR/$APPLICATION_BUNDLE_DIR/Contents/MacOS/
          
          cp $PUBLISH_DIR/${{ inputs.APPLICATION_TARGET_NAME }} $PUBLISH_DIR/$APPLICATION_BUNDLE_DIR/Contents/MacOS/
          cp $PUBLISH_DIR/appsettings.json $PUBLISH_DIR/$APPLICATION_BUNDLE_DIR/Contents/MacOS/ 
          cp $PUBLISH_DIR/*.dylib $PUBLISH_DIR/$APPLICATION_BUNDLE_DIR/Contents/MacOS/

          cat > $PUBLISH_DIR/$APPLICATION_BUNDLE_DIR/Contents/Info.plist <<EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN"
          "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
            <dict>
              <key>CFBundleName</key><string>$APPLICATION_NAME</string>
              <key>CFBundleExecutable</key><string>$APPLICATION_TARGET_NAME</string>
              <key>CFBundlePackageType</key><string>APPL</string>
              <key>CFBundleVersion</key><string>${{ inputs.APPLICATION_VERSION }}</string>
            </dict>
          </plist>
          EOF
          
          # Ad-hoc sign the .app
          codesign --force --deep --sign - $PUBLISH_DIR/$APPLICATION_BUNDLE_NAME

          # Remove quarantine flags to prevent "damaged" messages
          xattr -rc $PUBLISH_DIR/$APPLICATION_BUNDLE_NAME
          
          cd $PUBLISH_DIR
          
          # SHA256 checksum for the executable
          sha256sum $APPLICATION_BUNDLE_NAME/Contents/MacOS/${{ inputs.APPLICATION_TARGET_NAME }} > \
          $APPLICATION_BUNDLE_NAME/Contents/MacOS/${{ inputs.APPLICATION_TARGET_NAME }}.sha256
    
          # Create .dmg with checksum
          hdiutil create $APPLICATION_NAME.dmg -volname "$APPLICATION_NAME" -srcfolder $APPLICATION_BUNDLE_DIR -ov -format UDZO
          sha256sum $APPLICATION_NAME.dmg > $APPLICATION_NAME.dmg.sha256
          
      - name: "Upload Release Assets"
        run: |
          gh release upload ${{ github.event.release.tag_name }} $PUBLISH_DIR/$APPLICATION_NAME.dmg
          gh release upload ${{ github.event.release.tag_name }} $PUBLISH_DIR/$APPLICATION_NAME.dmg.sha256
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # Default token has required permissions
